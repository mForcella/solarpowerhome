<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, height=device-height,  initial-scale=1.0, user-scalable=no, user-scalable=0"/>
	<meta name="robots" content="noindex">
	<!-- <meta property="og:image" content="https://crabagain.com/assets/image/treasure-header-desaturated.jpg"> -->
	<title>Solar Power Home</title>
	<link rel="icon" type="image/png" href="/image/favicon.ico"/>

	<!-- Bootstrap -->
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
	<!-- jQuery UI -->
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
	<!-- Google Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;800&family=Alegreya:ital,wght@0,400;1,400;1,600&family=Merriweather:wght@300;700&display=swap" rel="stylesheet">

	<style>
		.header {
			height: 150px;
			padding: 25px;
		}
		.header img {
			max-height: 100px;
		}
		.content.row {
			padding-left: 5vw;
			padding-right: 5vw;
		}
		.area-row, #area_inputs {
			padding-top: 10px;
		}
		.area-row input, #total_area {
			margin: 0 5px;
			width: auto;
		}
		.btn-row {
			margin-top: 15px;
		}
		.btn-rotate {
			width: 100px;
		}
		.btn-remove {
			width: auto;
		}
		#map_container {
			margin-top: 30px;
		}
		#map {
		    height: 450px;
		    margin: 10px auto;
		    max-width: 900px;
		}
		#rotate_controls, #go_back {
			margin-top: 30px;
			display: none;
			text-align: center;
		}
		#area_inputs {
			display: none;
			margin-bottom: 100px;
		}
		#map_overlay, .shape-canvas {
			position: relative;
			margin-bottom: -475px;
			top: -475px;
			padding: 15px;
			pointer-events: none;
			display: none;
		}
		.shape-canvas {
			position: absolute;
			top: 10px;
			padding: 0;
		}
		#map_overlay .row {
			border: 1px solid black;
			height: 26px;
		    margin: 0 auto;
			margin-top: -1px;
			overflow: hidden;
		    max-width: 900px;
		}
		#map_overlay .col {
			border-right: 1px solid black;
			width: 26px;
			display: inline-block;
			height: 100%;
		}
	</style>

</head>

<body>

	<div class="header">
		<img src="/image/logo.png">
	</div>

	<div class="content row">
		<div class="col col-md-12">
			<p>Enter your address below to calculate your solar array size.</p>
			<input type="text" class="form-control" id="map_address">
		</div>
		<div class="col col-md-12" id="rotate_controls">
			<p>Use the controls below to orient your roof parallel with the grid lines. Click Continue when done. </p>
			<button class="btn btn-primary btn-rotate" id="rotate_right"><i class="fa-solid fa-rotate-right"></i></button>
			<button class="btn btn-primary btn-rotate" id="rotate_left"><i class="fa-solid fa-rotate-left"></i></button>
			<div class="row btn-row">
				<button class="btn btn-primary" onclick="confirmHeading()">Confirm</button>
			</div>
		</div>
		<div class="col col-md-12" id="go_back">
			<button class="btn btn-primary" onclick="changeHeading()">Adjust Map Heading</button>
		</div>
	</div>
	<div class="content row" id="map_container">
		<div class="col col-md-12">
    		<div id="map" class="map"></div>
    		<div id="map_overlay"></div>
    		<canvas id="shape_canvas" class="shape-canvas" height="450"></canvas>
		</div>
		<!-- TODO add option to switch to polyline drawing? -->
		<div class="col col-md-12" id="area_inputs">
			<div class="row">
				<!-- <button class="btn btn-primary" type="button">Confirm Array Configuration</button> -->
			</div>
			<label class="control-label">Total array area (square meters)</label>
			<input type="number" readonly id="total_area" value="0">
			<button class="btn btn-primary" type="button" onclick="clearMap()">Clear Map</button>
		</div>
	</div>



	<!-- step 4 - confirm shapes -->

	<!-- step 5 - go to configurator page -->

	<!-- step 6 - choose your equipment -->

	<!-- step 7 - click to lay panels in area (option to fill in all available space) -->

	<!-- step 8 - confirm and get quote -->



	<!-- need option - 'skip and jump to configurator' -->



	<!-- the configurator -->

		<!-- user selects the panel module type -->

		<!-- user selects the inverter type -->

		<!-- from area size, determine how many panels will be needed -->

		<!-- user can scale back the number of panels if desired -->

		<!-- user confirms panel number selection -->

		<!-- output a detailed quote -->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

	<script type="text/javascript">

		var map;
		var rotateRight, rotateLeft = false;

		// shape drawing variables
		var overlays = [];
		var shapes = [];
		var isDown = false;
		var iterator_id = 0;
		var canvas, ctx, startX, startY, offsetX, offsetY, scrollX, scrollY, height, width;

		// add grid overlay to map
		for (var i = 0; i < 18; i++) {
			let row = $('<div />', {
				'class': "row"
			}).appendTo($("#map_overlay"));
			for (var j = 0; j < 100; j++) {
				$('<div />', {
					'class': "col"
				}).appendTo(row);
			}
		}

		$("#rotate_right").on("mousedown", function() {
			rotateRight = true;
			setTimeout(function() {
				rotate();
			}, 50);
		});
		$("#rotate_right").on("mouseup", function() {
			rotateRight = false;
		});
		$("#rotate_left").on("mousedown", function() {
			rotateLeft = true;
			setTimeout(function() {
				rotate();
			}, 50);
		});
		$("#rotate_left").on("mouseup", function() {
			rotateLeft = false;
		});

		function rotate() {
			if (rotateLeft) {
				map.setHeading(map.getHeading() + 1);
			}
			if (rotateRight) {
				map.setHeading(map.getHeading() - 1);
			}
			if (rotateLeft || rotateRight) {
				setTimeout(function() {
					rotate();
				}, 50);
			}
		}

		function changeHeading() {
			$("#go_back").hide(1000, function(){
	        	$("#map_overlay").show();
	        	$("#rotate_controls").show(1000);
	        	$("#area_inputs").hide(1000);
	        	$("#map").css("pointer-events","auto");
	    		$("#shape_canvas").css("pointer-events","none");
	    		// disable canvas drawing
	    		$(".shape-canvas").css("pointer-events","none");
			});
		}

		function confirmHeading() {
			// hide grid and rotation controls
			$("#go_back").show(1000);
        	$("#map_overlay").hide();
        	$("#map").css("pointer-events","none");
        	$("#rotate_controls").hide(1000, function() {
        		$(".shape-canvas").css("pointer-events","auto");
	        	$("#area_inputs").show(1000);
            	// clone a new canvas and enable drawing on it
            	let new_canvas = $("#shape_canvas").clone();
            	$(new_canvas).attr("id", iterator_id);
	        	$(new_canvas).attr("width", $("#map").width());
            	$("#map_overlay").after(new_canvas);
	        	$(new_canvas).show();
            	enableShapeDrawing(iterator_id);
        	});
		}

		// https://stackoverflow.com/questions/65376480/let-users-draw-rectangles-with-mouse-in-canvas-with-javascript
		function enableShapeDrawing() {

			// calculate where the canvas is on the window
			canvas = document.getElementById(iterator_id);

			// get references to the canvas and context
			ctx = canvas.getContext("2d");
			ctx.strokeStyle = "black";
			ctx.lineWidth = 3;
			shapes[iterator_id] = ctx;

			let $canvas = $("#"+iterator_id);
			let canvasOffset = $canvas.offset();
			offsetX = canvasOffset.left;
			offsetY = canvasOffset.top;

			// listen for mouse events
			$("#"+iterator_id).mousedown(function (e) { handleMouseDown(e); });
			$("#"+iterator_id).mousemove(function (e) { handleMouseMove(e); });
			$("#"+iterator_id).mouseup(function (e) { handleMouseUp(e); });
			$("#"+iterator_id).mouseout(function (e) { handleMouseOut(e); });

		}

		function createAreaInput(s1, s2) {
			// create inputs for polygon
			let row = $('<div />', {
				'class': "area-row",
				'id': "row_"+iterator_id
			}).appendTo($("#area_inputs"));
			$('<label />', {
				'class': "control-label",
				'text': "Array Dimensions (m)"
			}).appendTo(row);
			$('<input />', {
				'type': "text",
				'value': s1.toFixed(2)+" x "+s2.toFixed(2),
				'id': "area_"+iterator_id
			}).appendTo(row);
			let button = $('<button />', {
				'class': "btn btn-primary btn-remove",
				'text': "Remove Array",
				'type': "button",
				'id': iterator_id++
			}).appendTo(row);
			button.on("click", function() {
				clearMap(this.id);
			});
		}

		// convert DOM x-y coordinates to lat-lng
		// https://stackoverflow.com/questions/25219346/how-to-convert-from-x-y-screen-coordinates-to-latlng-google-maps
		function point2LatLng(pointX, pointY) {
			// TODO adjust topRight and bottomLeft based on headding to find correct location on rotated map
			var topRight = map.getProjection().fromLatLngToPoint(map.getBounds().getNorthEast());
			var bottomLeft = map.getProjection().fromLatLngToPoint(map.getBounds().getSouthWest());
			var scale = Math.pow(2, map.getZoom());
			var worldPoint = new google.maps.Point(pointX / scale + bottomLeft.x, pointY / scale + topRight.y);
			return map.getProjection().fromPointToLatLng(worldPoint);
		}

		// begin shape drawing
		function handleMouseDown(e) {
		    e.preventDefault();
		    e.stopPropagation();

		    // save the starting x/y of the rectangle
		    scrollY  = window.pageYOffset || document.documentElement.scrollTop;
		    startX = parseInt(e.clientX - offsetX);
		    startY = parseInt(e.clientY - offsetY + scrollY);

		    // set a flag indicating the drag has begun
		    isDown = true;
		}

		// end shape drawing
		function handleMouseUp(e) {
		    e.preventDefault();
		    e.stopPropagation();

		    // the drag is over, clear the dragging flag
		    isDown = false;

		    // calculate the size of the rectangle on the canvas
		    let points = [];
		    points.push(point2LatLng(startX, startY));
		    points.push(point2LatLng(startX+width, startY));
		    points.push(point2LatLng(startX+width, startY+height));
		    points.push(point2LatLng(startX, startY+height));
		    width = height = 0;

		    // TODO overlay not in the correct position if the map has been rotated
		    // var overlay = new google.maps.Polygon({
			// 	paths: points,
			// 	strokeColor: '#FF0000',
			// 	strokeOpacity: 0.8,
			// 	strokeWeight: 2,
			// 	fillColor: '#FF0000',
			// 	fillOpacity: 0.35
			// });
			// overlay.setMap(map);
			// overlays.push(overlay);
			// let sqMeters = google.maps.geometry.spherical.computeArea(overlay.getPath());

		    for (var i in points) {
		    	if (isNaN(points[i].lat()) || isNaN(points[i].lng())) {
		    		return;
		    	}
		    }
		    var overlay = new google.maps.Polygon({ paths: points });
			let sqMeters = google.maps.geometry.spherical.computeArea(overlay.getPath());
			if (sqMeters < 1) { return; }
			overlays[iterator_id] = overlay;

			let s1 = google.maps.geometry.spherical.computeDistanceBetween(points[0], points[1]);
			let s2 = google.maps.geometry.spherical.computeDistanceBetween(points[0], points[3]);
			createAreaInput(s1, s2);
			setTotalArea();

			// clone and create new canvas object
        	let new_canvas = $("#shape_canvas").clone();
        	$(new_canvas).attr("id", iterator_id);
        	$(new_canvas).attr("width", $("#map").width());
        	$("#map_overlay").after(new_canvas);
        	$(new_canvas).show();
        	enableShapeDrawing(iterator_id);
		}

		// end shape drawing
		function handleMouseOut(e) {
		    e.preventDefault();
		    e.stopPropagation();

		    // the drag is over, clear the dragging flag
		    isDown = false;

		    handleMouseUp(e);
		}

		function handleMouseMove(e) {
		    e.preventDefault();
		    e.stopPropagation();

		    // if we're not dragging, just return
		    if (!isDown) { return; }

		    // get the current mouse position
		    mouseX = parseInt(e.clientX - offsetX);
		    mouseY = parseInt(e.clientY - offsetY);

		    // clear the canvas
		    ctx.clearRect(0, 0, canvas.width, canvas.height);

		    // calculate the rectangle width/height
		    width = mouseX - startX;
		    height = mouseY - startY + scrollY;

		    // draw a new rect from the start position 
		    ctx.strokeRect(startX, startY, width, height);

		}

		function initMap() {

		    map = new google.maps.Map(document.getElementById('map'), {
		        center: {lat: 41.798057, lng: -93.973488},
		        zoom: 3,
		        mapTypeId: 'satellite',
		        streetViewControl: false,
		        mapId: "90f87356969d889c",
		    });

			// initialize the google map and inputs
	        let options = { componentRestrictions: {country: ['us', 'ca']} };
	        let input = document.getElementById('map_address');
	        let departure_autocomplete = new google.maps.places.Autocomplete(input, options);

	        // TODO try to disable tilt?
	        // google.maps.event.addListener(map, 'tilt_changed', function() {
			//     if (map.getTilt() != 0) {
			//         map.setTilt(0);
			//     }
			// });

            // set select function for address input
            google.maps.event.addListener(departure_autocomplete, 'place_changed', function() {
            	// on place changed, show map grid overlay, prompt to rotate map
            	$("#map_overlay").show();
            	$("#rotate_controls").show(1000);

                if (departure_autocomplete.getPlace().geometry == undefined) {
                    return;
                }
                // zoom to location on map
                map.setCenter(departure_autocomplete.getPlace().geometry.location);
                // TODO can't zoom past level 19 on first place change
            	map.setZoom(20);
            });
		}

		// calculate total area from all polygon overlays
		function setTotalArea() {
			var area = 0;
			for (var i in overlays) {
				if (overlays[i] != null) {
					let sqMeters = google.maps.geometry.spherical.computeArea(overlays[i].getPath());
					area += sqMeters;
				}
			}
			$("#total_area").val(area.toFixed(2));
		}

		// clear shapes from map
		function clearMap(polygon_id) {
			// clear all shapes
			if (polygon_id == undefined) {
				for (var i in shapes) {
					if (shapes[i] != null) {
						shapes[i].clearRect(0, 0, canvas.width, canvas.height);
					}
					$("#row_"+i).remove();
					$("#"+i).remove();
				}
				overlays = [];
				shapes = [];
				iterator_id = 0;
				$("#total_area").val(0);
				cloneCanvas();

			} else {
				// clear a single shape
				shapes[polygon_id].clearRect(0, 0, canvas.width, canvas.height);
				shapes[polygon_id] = null;
				overlays[polygon_id] = null;
				$("#row_"+polygon_id).remove();
				$("#"+polygon_id).remove();
				setTotalArea();
			}
		}

		// create a new shape drawing canvas
		function cloneCanvas() {
        	let new_canvas = $("#shape_canvas").clone();
        	$(new_canvas).attr("id", iterator_id);
        	$(new_canvas).attr("width", $("#map").width());
        	$("#map_overlay").after(new_canvas);
        	$(new_canvas).show();
        	enableShapeDrawing(iterator_id);
		}

	</script>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtocRbc2TsrDu6Oz6jAo3LcPGLPnXYDSw&callback=initMap&v=beta&libraries=places,drawing,geometry" async defer></script>

</body>
</html>